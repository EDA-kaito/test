<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¡ç”¨å€™è£œè€…åˆ†æã‚·ã‚¹ãƒ†ãƒ  - Sierå‘ã‘</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 40px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.2em;
            margin-bottom: 10px;
        }

        .header .subtitle {
            opacity: 0.9;
            font-size: 1.1em;
        }

        .tech-badges {
            margin-top: 15px;
            display: flex;
            justify-content: center;
            gap: 10px;
        }

        .badge {
            background: rgba(255, 255, 255, 0.2);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
        }

        .content {
            padding: 40px;
        }

        .settings-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 30px;
            border: 2px solid #e9ecef;
        }

        .settings-section h3 {
            margin-bottom: 20px;
            color: #1e3c72;
            font-size: 1.3em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .input-group {
            margin-bottom: 15px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #495057;
        }

        .input-group input {
            width: 100%;
            padding: 14px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 15px;
            transition: all 0.3s;
        }

        .input-group input:focus {
            outline: none;
            border-color: #2a5298;
            box-shadow: 0 0 0 3px rgba(42, 82, 152, 0.1);
        }

        .upload-section {
            border: 3px dashed #2a5298;
            border-radius: 12px;
            padding: 50px;
            text-align: center;
            margin-bottom: 25px;
            cursor: pointer;
            transition: all 0.3s;
            background: #f8f9ff;
        }

        .upload-section:hover {
            background: #e8eeff;
            border-color: #1e3c72;
            transform: translateY(-2px);
        }

        .upload-section.dragover {
            background: #d6e4ff;
            border-color: #1e3c72;
            transform: scale(1.02);
        }

        .upload-icon {
            font-size: 56px;
            margin-bottom: 15px;
        }

        .upload-section h3 {
            color: #1e3c72;
            margin-bottom: 10px;
        }

        .file-input {
            display: none;
        }

        .btn {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            border: none;
            padding: 18px 40px;
            border-radius: 10px;
            font-size: 17px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 24px rgba(30, 60, 114, 0.3);
        }

        .btn:active {
            transform: translateY(-1px);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .result-section {
            margin-top: 30px;
            display: none;
        }

        .result-section.show {
            display: block;
            animation: fadeIn 0.5s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .analysis-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .analysis-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            border: 2px solid #e9ecef;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            transition: all 0.3s;
        }

        .analysis-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.1);
            border-color: #2a5298;
        }

        .analysis-card h4 {
            color: #1e3c72;
            margin-bottom: 15px;
            font-size: 1.2em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .analysis-card .content {
            padding: 0;
            line-height: 1.8;
            color: #495057;
        }

        .score-section {
            background: linear-gradient(135deg, #f8f9ff 0%, #e8eeff 100%);
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 30px;
            border: 2px solid #d6e4ff;
        }

        .score-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .score-item {
            text-align: center;
        }

        .score-label {
            font-size: 14px;
            color: #6c757d;
            margin-bottom: 10px;
        }

        .score-value {
            font-size: 42px;
            font-weight: 700;
            color: #1e3c72;
        }

        .score-bar {
            width: 100%;
            height: 8px;
            background: #dee2e6;
            border-radius: 10px;
            overflow: hidden;
            margin-top: 10px;
        }

        .score-fill {
            height: 100%;
            background: linear-gradient(90deg, #1e3c72 0%, #2a5298 100%);
            border-radius: 10px;
            transition: width 1s ease;
        }

        .detailed-analysis {
            background: white;
            padding: 30px;
            border-radius: 12px;
            border: 2px solid #e9ecef;
            line-height: 1.9;
            white-space: pre-wrap;
        }

        .detailed-analysis h3 {
            color: #1e3c72;
            margin-bottom: 20px;
            font-size: 1.4em;
        }

        .loading {
            text-align: center;
            padding: 40px;
            display: none;
        }

        .loading.show {
            display: block;
        }

        .spinner {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #2a5298;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error {
            background: #fee;
            color: #c33;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            display: none;
            border: 2px solid #fcc;
        }

        .error.show {
            display: block;
        }

        .file-info {
            background: #d4edda;
            color: #155724;
            padding: 15px 20px;
            border-radius: 10px;
            margin-top: 15px;
            display: none;
            border: 2px solid #c3e6cb;
            font-weight: 600;
        }

        .file-info.show {
            display: block;
        }

        .history-section {
            margin-top: 40px;
        }

        .history-section h3 {
            color: #1e3c72;
            margin-bottom: 20px;
            font-size: 1.4em;
        }

        .history-item {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .history-item:hover {
            background: #e8eeff;
            border-color: #2a5298;
            transform: translateX(5px);
        }

        .history-item-info {
            flex: 1;
        }

        .history-item-title {
            font-weight: 700;
            color: #1e3c72;
            margin-bottom: 8px;
            font-size: 1.1em;
        }

        .history-item-date {
            font-size: 13px;
            color: #6c757d;
        }

        .history-item-score {
            font-size: 32px;
            font-weight: 700;
            color: #2a5298;
        }

        .recommendation-badge {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 14px;
            margin-top: 10px;
        }

        .recommendation-high {
            background: #d4edda;
            color: #155724;
        }

        .recommendation-medium {
            background: #fff3cd;
            color: #856404;
        }

        .recommendation-low {
            background: #f8d7da;
            color: #721c24;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¯ æ¡ç”¨å€™è£œè€…åˆ†æã‚·ã‚¹ãƒ†ãƒ </h1>
            <p class="subtitle">Sierä¼æ¥­å‘ã‘ - AIå€™è£œè€…è©•ä¾¡ãƒ„ãƒ¼ãƒ«</p>
            <div class="tech-badges">
                <span class="badge">ğŸ˜ PHP</span>
                <span class="badge">ğŸ“± Flutter</span>
                <span class="badge">ğŸ¤– Gemini AI</span>
            </div>
        </div>

        <div class="content">
            <!-- APIè¨­å®šã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div class="settings-section">
                <h3>âš™ï¸ ã‚·ã‚¹ãƒ†ãƒ è¨­å®š</h3>
                <div class="input-group">
                    <label>Supabase URL</label>
                    <input type="text" id="supabaseUrl" placeholder="https://xxxxx.supabase.co">
                </div>
                <div class="input-group">
                    <label>Supabase Anon Key</label>
                    <input type="password" id="supabaseKey" placeholder="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...">
                </div>
                <div class="input-group">
                    <label>Gemini API Key</label>
                    <input type="password" id="geminiKey" placeholder="AIzaSy...">
                </div>
            </div>

            <!-- ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div class="upload-section" id="uploadArea">
                <div class="upload-icon">ğŸ“‹</div>
                <h3>è·å‹™çµŒæ­´æ›¸ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</h3>
                <p>å€™è£œè€…ã®è·å‹™çµŒæ­´æ›¸ã‚’ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã¾ãŸã¯ã‚¯ãƒªãƒƒã‚¯ã—ã¦é¸æŠ</p>
                <p style="font-size: 13px; color: #6c757d; margin-top: 12px;">å¯¾å¿œå½¢å¼: PDF, DOC, DOCX, TXT</p>
                <input type="file" id="fileInput" class="file-input" accept=".pdf,.doc,.docx,.txt">
            </div>

            <div class="file-info" id="fileInfo"></div>

            <button class="btn" id="analyzeBtn" disabled>
                <span>ğŸ”</span>
                <span>å€™è£œè€…ã‚’åˆ†æã™ã‚‹</span>
            </button>

            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p style="font-size: 16px; color: #495057;">AIãŒå€™è£œè€…ã‚’åˆ†æã—ã¦ã„ã¾ã™...</p>
                <p style="font-size: 14px; color: #6c757d; margin-top: 10px;">PHPãƒ»Flutteré–‹ç™ºã‚¹ã‚­ãƒ«ã‚’è©•ä¾¡ä¸­</p>
            </div>

            <div class="error" id="error"></div>

            <!-- åˆ†æçµæœã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div class="result-section" id="resultSection">
                <!-- ç·åˆè©•ä¾¡ã‚¹ã‚³ã‚¢ -->
                <div class="score-section">
                    <h3 style="color: #1e3c72; margin-bottom: 10px;">ğŸ“Š ç·åˆè©•ä¾¡ã‚¹ã‚³ã‚¢</h3>
                    <div class="score-grid">
                        <div class="score-item">
                            <div class="score-label">ç·åˆè©•ä¾¡</div>
                            <div class="score-value" id="overallScore">-</div>
                            <div class="score-bar">
                                <div class="score-fill" id="overallBar" style="width: 0%"></div>
                            </div>
                        </div>
                        <div class="score-item">
                            <div class="score-label">æŠ€è¡“é©åˆåº¦</div>
                            <div class="score-value" id="techScore">-</div>
                            <div class="score-bar">
                                <div class="score-fill" id="techBar" style="width: 0%"></div>
                            </div>
                        </div>
                        <div class="score-item">
                            <div class="score-label">Sieré©æ€§</div>
                            <div class="score-value" id="sierScore">-</div>
                            <div class="score-bar">
                                <div class="score-fill" id="sierBar" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                    <div id="recommendationBadge"></div>
                </div>

                <!-- åˆ†æã‚«ãƒ¼ãƒ‰ã‚°ãƒªãƒƒãƒ‰ -->
                <div class="analysis-grid">
                    <div class="analysis-card">
                        <h4>ğŸ’ª å€™è£œè€…ã®å¼·ã¿</h4>
                        <div class="content" id="strengths"></div>
                    </div>
                    <div class="analysis-card">
                        <h4>ğŸ¯ ã‚¢ãƒ”ãƒ¼ãƒ«ãƒã‚¤ãƒ³ãƒˆ</h4>
                        <div class="content" id="highlights"></div>
                    </div>
                    <div class="analysis-card">
                        <h4>ğŸ¢ ç¤¾å†…ã§ã®æ´»èºå¯èƒ½æ€§</h4>
                        <div class="content" id="potentials"></div>
                    </div>
                    <div class="analysis-card">
                        <h4>ğŸ”§ æŠ€è¡“ã‚¹ã‚­ãƒ«è©•ä¾¡</h4>
                        <div class="content" id="techSkills"></div>
                    </div>
                    <div class="analysis-card">
                        <h4>ğŸ’¼ Sieræ¥­å‹™ã¸ã®é©æ€§</h4>
                        <div class="content" id="sierFit"></div>
                    </div>
                    <div class="analysis-card">
                        <h4>âš ï¸ æ‡¸å¿µç‚¹ãƒ»ç¢ºèªäº‹é …</h4>
                        <div class="content" id="concerns"></div>
                    </div>
                </div>

                <!-- è©³ç´°åˆ†æ -->
                <div class="detailed-analysis">
                    <h3>ğŸ“ è©³ç´°åˆ†æãƒ¬ãƒãƒ¼ãƒˆ</h3>
                    <div id="detailedAnalysis"></div>
                </div>
            </div>

            <!-- åˆ†æå±¥æ­´ -->
            <div class="history-section">
                <h3>ğŸ“š åˆ†æå±¥æ­´ï¼ˆå€™è£œè€…ä¸€è¦§ï¼‰</h3>
                <div id="historyList"></div>
            </div>
        </div>
    </div>

    <script>
        let currentFile = null;
        let currentAnalysis = null;

        // DOMè¦ç´ 
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const fileInfo = document.getElementById('fileInfo');
        const analyzeBtn = document.getElementById('analyzeBtn');
        const loading = document.getElementById('loading');
        const error = document.getElementById('error');
        const resultSection = document.getElementById('resultSection');
        const historyList = document.getElementById('historyList');

        const supabaseUrlInput = document.getElementById('supabaseUrl');
        const supabaseKeyInput = document.getElementById('supabaseKey');
        const geminiKeyInput = document.getElementById('geminiKey');

        // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰è¨­å®šã‚’èª­ã¿è¾¼ã¿
        window.addEventListener('load', () => {
            supabaseUrlInput.value = localStorage.getItem('supabaseUrl') || '';
            supabaseKeyInput.value = localStorage.getItem('supabaseKey') || '';
            geminiKeyInput.value = localStorage.getItem('geminiKey') || '';
            
            loadHistory();
        });

        // è¨­å®šã®ä¿å­˜
        [supabaseUrlInput, supabaseKeyInput, geminiKeyInput].forEach(input => {
            input.addEventListener('change', () => {
                localStorage.setItem('supabaseUrl', supabaseUrlInput.value);
                localStorage.setItem('supabaseKey', supabaseKeyInput.value);
                localStorage.setItem('geminiKey', geminiKeyInput.value);
                if (input === supabaseUrlInput || input === supabaseKeyInput) {
                    loadHistory();
                }
            });
        });

        // ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å‡¦ç†
        uploadArea.addEventListener('click', () => fileInput.click());

        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFile(e.target.files[0]);
            }
        });

        function handleFile(file) {
            currentFile = file;
            fileInfo.innerHTML = `ğŸ“„ <strong>${file.name}</strong> (${(file.size / 1024).toFixed(2)} KB)`;
            fileInfo.classList.add('show');
            analyzeBtn.disabled = false;
            resultSection.classList.remove('show');
            error.classList.remove('show');
        }

        // åˆ†æãƒœã‚¿ãƒ³
        analyzeBtn.addEventListener('click', analyzeCandidate);

        async function analyzeCandidate() {
            if (!currentFile) return;

            const geminiKey = geminiKeyInput.value;
            if (!geminiKey) {
                showError('Gemini API Keyã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            const supabaseUrl = supabaseUrlInput.value;
            const supabaseKey = supabaseKeyInput.value;
            if (!supabaseUrl || !supabaseKey) {
                showError('Supabaseã®è¨­å®šã‚’å®Œäº†ã—ã¦ãã ã•ã„');
                return;
            }

            loading.classList.add('show');
            error.classList.remove('show');
            resultSection.classList.remove('show');
            analyzeBtn.disabled = true;

            try {
                // ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ†ã‚­ã‚¹ãƒˆã¨ã—ã¦èª­ã¿è¾¼ã¿
                const text = await readFileAsText(currentFile);

                // Gemini APIã§åˆ†æ
                const analysis = await analyzeWithGemini(text, geminiKey);
                currentAnalysis = analysis;

                // çµæœã‚’è¡¨ç¤º
                displayAnalysis(analysis);
                resultSection.classList.add('show');

                // Supabaseã«ä¿å­˜ï¼ˆã‚¨ãƒ©ãƒ¼ãŒå‡ºã¦ã‚‚åˆ†æçµæœã¯è¡¨ç¤ºã™ã‚‹ï¼‰
                try {
                    await saveToSupabase(currentFile.name, text, analysis, supabaseUrl, supabaseKey);
                    // å±¥æ­´ã‚’æ›´æ–°
                    loadHistory();
                } catch (saveErr) {
                    console.error('ä¿å­˜ã‚¨ãƒ©ãƒ¼:', saveErr);
                    // ä¿å­˜ã‚¨ãƒ©ãƒ¼ã¯è­¦å‘Šã¨ã—ã¦è¡¨ç¤ºã™ã‚‹ãŒã€åˆ†æçµæœã¯è¦‹ãˆã‚‹
                    const warningDiv = document.createElement('div');
                    warningDiv.style.cssText = 'background: #fff3cd; color: #856404; padding: 15px; border-radius: 10px; margin-top: 20px; border: 2px solid #ffc107;';
                    warningDiv.innerHTML = `âš ï¸ <strong>åˆ†æã¯å®Œäº†ã—ã¾ã—ãŸãŒã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¸ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚</strong><br>ã‚¨ãƒ©ãƒ¼: ${saveErr.message}`;
                    resultSection.insertBefore(warningDiv, resultSection.firstChild);
                }

                // ã‚¹ãƒ ãƒ¼ã‚ºã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
                setTimeout(() => {
                    resultSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }, 300);

            } catch (err) {
                showError('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + err.message);
                console.error(err);
            } finally {
                loading.classList.remove('show');
                analyzeBtn.disabled = false;
            }
        }

        function readFileAsText(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => resolve(e.target.result);
                reader.onerror = () => reject(new Error('ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ'));
                reader.readAsText(file);
            });
        }

        async function analyzeWithGemini(text, apiKey) {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${apiKey}`;
            
            const prompt = `ã‚ãªãŸã¯Sierä¼æ¥­ï¼ˆPHPãƒ»Flutteré–‹ç™ºï¼‰ã®æ¡ç”¨æ‹…å½“AIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚ä»¥ä¸‹ã®è·å‹™çµŒæ­´æ›¸ã‚’åˆ†æã—ã€JSONå½¢å¼ã§è©•ä¾¡çµæœã‚’è¿”ã—ã¦ãã ã•ã„ã€‚

ã€ä¼šç¤¾æƒ…å ±ã€‘
- æ¥­ç¨®: Sierï¼ˆã‚·ã‚¹ãƒ†ãƒ ã‚¤ãƒ³ãƒ†ã‚°ãƒ¬ãƒ¼ã‚¿ãƒ¼ï¼‰
- ä¸»è¦æŠ€è¡“: PHPï¼ˆãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ï¼‰ã€Flutterï¼ˆãƒ¢ãƒã‚¤ãƒ«ã‚¢ãƒ—ãƒªé–‹ç™ºï¼‰
- ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå½¢æ…‹: å—è¨—é–‹ç™ºã€æ¥­å‹™ã‚·ã‚¹ãƒ†ãƒ é–‹ç™º

ã€åˆ†æé …ç›®ã€‘
1. overallScore: ç·åˆè©•ä¾¡ï¼ˆ100ç‚¹æº€ç‚¹ï¼‰
2. techScore: æŠ€è¡“é©åˆåº¦ï¼ˆ100ç‚¹æº€ç‚¹ï¼‰- PHP/Flutterã‚¹ã‚­ãƒ«é‡è¦–
3. sierScore: Sieré©æ€§ï¼ˆ100ç‚¹æº€ç‚¹ï¼‰- é¡§å®¢æŠ˜è¡ã€è¦ä»¶å®šç¾©ã€ãƒãƒ¼ãƒ é–‹ç™ºçµŒé¨“
4. strengths: å€™è£œè€…ã®ä¸»ãªå¼·ã¿ï¼ˆç®‡æ¡æ›¸ã3-5é …ç›®ï¼‰
5. highlights: æ¡ç”¨æ‹…å½“è€…ã¸ã®ã‚¢ãƒ”ãƒ¼ãƒ«ãƒã‚¤ãƒ³ãƒˆï¼ˆç®‡æ¡æ›¸ã3-5é …ç›®ï¼‰
6. potentials: ç¤¾å†…ã§ã®æ´»èºå¯èƒ½æ€§ãƒ»æœŸå¾…ã•ã‚Œã‚‹è²¢çŒ®ï¼ˆç®‡æ¡æ›¸ã3-5é …ç›®ï¼‰
7. techSkills: æŠ€è¡“ã‚¹ã‚­ãƒ«è©³ç´°è©•ä¾¡ï¼ˆPHP/Flutter/ãã®ä»–é–¢é€£æŠ€è¡“ï¼‰
8. sierFit: Sieræ¥­å‹™ã¸ã®é©æ€§è©•ä¾¡
9. concerns: æ‡¸å¿µç‚¹ã‚„é¢æ¥ã§ç¢ºèªã™ã¹ãäº‹é …ï¼ˆç®‡æ¡æ›¸ã2-4é …ç›®ï¼‰
10. recommendation: æ¨å¥¨åº¦ï¼ˆ"é«˜"/"ä¸­"/"ä½"ï¼‰
11. detailedAnalysis: è©³ç´°ãªç·åˆåˆ†æãƒ¬ãƒãƒ¼ãƒˆï¼ˆæ®µè½å½¢å¼ï¼‰

è·å‹™çµŒæ­´æ›¸:
${text}

å¿…ãšJSONå½¢å¼ã§è¿”ç­”ã—ã¦ãã ã•ã„ã€‚`;

            const response = await fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    contents: [{
                        parts: [{
                            text: prompt
                        }]
                    }]
                })
            });

            if (!response.ok) {
                throw new Error(`Gemini API ã‚¨ãƒ©ãƒ¼: ${response.status}`);
            }

            const data = await response.json();
            const resultText = data.candidates[0].content.parts[0].text;
            
            // JSONã‚’æŠ½å‡º
            const jsonMatch = resultText.match(/\{[\s\S]*\}/);
            if (jsonMatch) {
                return JSON.parse(jsonMatch[0]);
            } else {
                throw new Error('JSONã®è§£æã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        }

        function displayAnalysis(analysis) {
            // ã‚¹ã‚³ã‚¢è¡¨ç¤º
            document.getElementById('overallScore').textContent = analysis.overallScore || '-';
            document.getElementById('techScore').textContent = analysis.techScore || '-';
            document.getElementById('sierScore').textContent = analysis.sierScore || '-';

            // ã‚¹ã‚³ã‚¢ãƒãƒ¼ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
            setTimeout(() => {
                document.getElementById('overallBar').style.width = (analysis.overallScore || 0) + '%';
                document.getElementById('techBar').style.width = (analysis.techScore || 0) + '%';
                document.getElementById('sierBar').style.width = (analysis.sierScore || 0) + '%';
            }, 100);

            // æ¨å¥¨åº¦ãƒãƒƒã‚¸
            const badge = document.getElementById('recommendationBadge');
            const recClass = analysis.recommendation === 'é«˜' ? 'recommendation-high' : 
                            analysis.recommendation === 'ä¸­' ? 'recommendation-medium' : 
                            'recommendation-low';
            badge.innerHTML = `<span class="recommendation-badge ${recClass}">æ¡ç”¨æ¨å¥¨åº¦: ${analysis.recommendation}</span>`;

            // å„ã‚»ã‚¯ã‚·ãƒ§ãƒ³
            document.getElementById('strengths').innerHTML = formatList(analysis.strengths);
            document.getElementById('highlights').innerHTML = formatList(analysis.highlights);
            document.getElementById('potentials').innerHTML = formatList(analysis.potentials);
            document.getElementById('techSkills').innerHTML = formatText(analysis.techSkills);
            document.getElementById('sierFit').innerHTML = formatText(analysis.sierFit);
            document.getElementById('concerns').innerHTML = formatList(analysis.concerns);
            document.getElementById('detailedAnalysis').textContent = analysis.detailedAnalysis || '';
        }

        function formatList(items) {
            if (Array.isArray(items)) {
                return '<ul style="margin-left: 20px;">' + 
                       items.map(item => `<li style="margin-bottom: 8px;">${item}</li>`).join('') + 
                       '</ul>';
            }
            return formatText(items);
        }

        function formatText(text) {
            if (typeof text === 'string') {
                return text.replace(/\n/g, '<br>');
            }
            return '';
        }

        // Supabase REST API ã‚’ä½¿ç”¨
        async function saveToSupabase(fileName, content, analysis, supabaseUrl, supabaseKey) {
            const url = `${supabaseUrl}/rest/v1/candidates`;
            
            const payload = {
                file_name: fileName,
                content: content,
                overall_score: analysis.overallScore,
                tech_score: analysis.techScore,
                sier_score: analysis.sierScore,
                recommendation: analysis.recommendation,
                analysis: analysis,
                created_at: new Date().toISOString()
            };

            const response = await fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'apikey': supabaseKey,
                    'Authorization': `Bearer ${supabaseKey}`,
                    'Prefer': 'return=minimal'
                },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                const errorText = await response.text();
                console.error('Supabaseä¿å­˜ã‚¨ãƒ©ãƒ¼:', errorText);
                throw new Error(`ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ä¿å­˜ã‚¨ãƒ©ãƒ¼: ${response.status}`);
            }
        }

        async function loadHistory() {
            const supabaseUrl = supabaseUrlInput.value;
            const supabaseKey = supabaseKeyInput.value;
            
            if (!supabaseUrl || !supabaseKey) {
                historyList.innerHTML = '<p style="color: #6c757d; text-align: center; padding: 30px;">Supabaseã®è¨­å®šã‚’å®Œäº†ã—ã¦ãã ã•ã„</p>';
                return;
            }

            try {
                const url = `${supabaseUrl}/rest/v1/candidates?select=*&order=created_at.desc&limit=20`;
                
                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'apikey': supabaseKey,
                        'Authorization': `Bearer ${supabaseKey}`
                    }
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('å±¥æ­´èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', errorText);
                    
                    if (response.status === 404 || errorText.includes('relation') || errorText.includes('does not exist')) {
                        historyList.innerHTML = `
                            <div style="background: #fff3cd; padding: 20px; border-radius: 10px; border: 2px solid #ffc107;">
                                <p style="color: #856404; margin-bottom: 10px;"><strong>âš ï¸ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ†ãƒ¼ãƒ–ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</strong></p>
                                <p style="color: #856404; font-size: 14px;">Supabaseã§ä»¥ä¸‹ã®SQLã‚’å®Ÿè¡Œã—ã¦ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½œæˆã—ã¦ãã ã•ã„ï¼š</p>
                                <pre style="background: white; padding: 15px; border-radius: 5px; margin-top: 10px; overflow-x: auto; font-size: 12px;">create table candidates (
  id bigint primary key generated always as identity,
  file_name text,
  content text,
  overall_score integer,
  tech_score integer,
  sier_score integer,
  recommendation text,
  analysis jsonb,
  created_at timestamp with time zone
);

-- RLSã‚’ç„¡åŠ¹åŒ–ï¼ˆãƒ†ã‚¹ãƒˆç”¨ï¼‰
alter table candidates disable row level security;</pre>
                            </div>
                        `;
                    } else {
                        throw new Error(`HTTP ${response.status}: ${errorText}`);
                    }
                    return;
                }

                const data = await response.json();
                historyList.innerHTML = '';
                
                if (data && data.length > 0) {
                    data.forEach(item => {
                        const div = document.createElement('div');
                        div.className = 'history-item';
                        
                        const recClass = item.recommendation === 'é«˜' ? 'recommendation-high' : 
                                        item.recommendation === 'ä¸­' ? 'recommendation-medium' : 
                                        'recommendation-low';
                        
                        div.innerHTML = `
                            <div class="history-item-info">
                                <div class="history-item-title">${item.file_name}</div>
                                <div class="history-item-date">${new Date(item.created_at).toLocaleString('ja-JP')}</div>
                                <span class="recommendation-badge ${recClass}" style="margin-top: 8px;">æ¨å¥¨åº¦: ${item.recommendation}</span>
                            </div>
                            <div class="history-item-score">${item.overall_score}</div>
                        `;
                        
                        div.addEventListener('click', () => {
                            const analysis = typeof item.analysis === 'string' ? JSON.parse(item.analysis) : item.analysis;
                            displayAnalysis(analysis);
                            resultSection.classList.add('show');
                            resultSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                        });
                        
                        historyList.appendChild(div);
                    });
                } else {
                    historyList.innerHTML = '<p style="color: #6c757d; text-align: center; padding: 30px;">ã¾ã å€™è£œè€…ã®åˆ†æå±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</p>';
                }
            } catch (err) {
                console.error('å±¥æ­´ã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', err);
                historyList.innerHTML = `
                    <div style="background: #fee; padding: 20px; border-radius: 10px; border: 2px solid #fcc;">
                        <p style="color: #c33; margin-bottom: 5px;"><strong>âŒ å±¥æ­´ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</strong></p>
                        <p style="color: #c33; font-size: 13px;">ã‚¨ãƒ©ãƒ¼: ${err.message}</p>
                        <p style="color: #c33; font-size: 13px; margin-top: 10px;">Supabaseã®è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚</p>
                    </div>
                `;
            }
        }

        function showError(message) {
            error.textContent = 'âŒ ' + message;
            error.classList.add('show');
        }
    </script>
</body>
</html>
